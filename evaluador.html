<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador 9US | Cambio de Uso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-slate-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm border-b p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <a href="index.html" class="text-2xl font-black text-slate-800 tracking-tighter">
                9<span class="text-blue-600">US</span>
            </a>
            <span class="text-sm font-bold text-gray-400 uppercase tracking-widest">Auditor√≠a de Viabilidad</span>
        </div>
    </nav>

    <div class="flex-grow p-4 md:p-8 flex items-center justify-center">
        <div id="informePDF" class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-2xl shadow-xl border border-gray-100">
            
            <div class="mb-8" data-html2canvas-ignore>
                <div class="flex justify-between mb-2">
                    <span id="progText1" class="text-xs font-bold text-blue-600 uppercase">1. Urbanismo</span>
                    <span id="progText2" class="text-xs font-bold text-gray-400 uppercase">2. T√©cnica</span>
                    <span id="progText3" class="text-xs font-bold text-gray-400 uppercase">3. Financiera</span>
                    <span id="progText4" class="text-xs font-bold text-gray-400 uppercase">4. Resultado</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
                </div>
            </div>

            <div id="paso1" class="paso-bloque block">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">Fase 1: Viabilidad Urban√≠stica</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <label class="block text-sm font-bold text-gray-700">Municipio de la inversi√≥n:</label>
                        <select id="municipioSelect" onchange="actualizarReglasMunicipio()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50">
                            <option value="general" selected>Resto de municipios (Norma General)</option>
                            <option value="barcelona">Barcelona (PIU)</option>
                            <option value="lhospitalet">L'Hospitalet de Llobregat</option>
                            <option value="terrassa">Terrassa</option>
                            <option value="sabadell">Sabadell</option>
                            <option value="mataro">Matar√≥</option>
                        </select>
                        <button onclick="abrirVisor()" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-2 rounded-lg transition">üîç Abrir Visor Oficial</button>
                        
                        <div id="avisosMunicipio" class="space-y-2 mt-4 text-xs p-3 bg-gray-50 rounded-lg border hidden">
                            <div id="avisoParking" class="text-indigo-700"></div>
                            <div id="avisoHumos" class="text-teal-700 mt-2"></div>
                        </div>
                    </div>

                    <div class="space-y-4 bg-emerald-50 p-5 rounded-xl border border-emerald-100">
                        <h3 class="font-bold text-emerald-900">An√°lisis de Densidad (Catastro)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs font-semibold">Parcela (m¬≤):</label><input type="number" id="superficieParcela" class="w-full p-2 border rounded mt-1"></div>
                            <div><label class="text-xs font-semibold">√çndice (m¬≤/viv):</label><input type="number" id="indiceDensidad" class="w-full p-2 border rounded mt-1"></div>
                        </div>
                        <div><label class="text-xs font-semibold">Viviendas existentes:</label><input type="number" id="viviendasExistentes" class="w-full p-2 border rounded mt-1"></div>
                        <button onclick="calcularDensidad()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg">Verificar Densidad</button>
                        <div id="resultadoDensidad" class="mt-2 text-center font-bold text-sm hidden p-2 rounded"></div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="irPaso2()" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg">Siguiente Paso ‚ûî</button>
                </div>
            </div>

            <div id="paso2" class="paso-bloque hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">Fase 2: Auditor√≠a T√©cnica (Habitabilidad)</h2>
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-center justify-between">
                        <label class="font-bold text-blue-900">¬øCu√°ntas viviendas vas a sacar? (Segregaci√≥n)</label>
                        <input type="number" id="numViviendasPlan" value="1" min="1" oninput="evaluarTecnico()" class="w-20 p-2 border rounded-lg text-center font-bold text-blue-900 text-lg">
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label id="labelSupMinima" class="text-sm font-bold text-gray-700">Sup. √∫til TOTAL (m¬≤):</label>
                            <input type="number" id="checkSuperficie" oninput="evaluarTecnico()" class="w-full p-3 border rounded-lg mt-1 bg-slate-50">
                            <div id="resSuperficie" class="text-xs font-medium mt-1 h-4"></div>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-700">Longitud Fachada Exterior (m):</label>
                            <input type="number" id="checkFachada" oninput="evaluarTecnico()" class="w-full p-3 border rounded-lg mt-1 bg-slate-50">
                            <div id="resFachada" class="text-xs font-medium mt-1 h-4"></div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6 pt-4 border-t">
                        <div>
                            <label class="text-sm font-bold text-gray-700">Estatutos Comunidad:</label>
                            <select class="w-full p-2 border rounded-lg mt-1 bg-slate-50"><option>Sin prohibici√≥n expresa</option><option>Con prohibici√≥n (Inviable)</option></select>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-700">Salida de Humos:</label>
                            <select class="w-full p-2 border rounded-lg mt-1 bg-slate-50"><option>A cubierta disponible</option><option>Posibilidad Filtro Carbono</option><option>Inviable</option></select>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="volver(1)" class="text-gray-500 hover:text-gray-800 font-bold py-3 px-6">‚¨Ö Atr√°s</button>
                    <button onclick="irPaso3()" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg">Siguiente Paso ‚ûî</button>
                </div>
            </div>

            <div id="paso3" class="paso-bloque hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">Fase 3: Modelado Financiero</h2>
                
                <div class="grid md:grid-cols-3 gap-6 bg-amber-50 p-6 rounded-xl border border-amber-100">
                    <div class="space-y-3">
                        <h3 class="font-black text-amber-900 uppercase text-xs tracking-wider">A. Adquisici√≥n</h3>
                        <div><label class="text-xs font-bold text-gray-700">Precio Compra (‚Ç¨):</label><input type="number" id="precioCompra" class="w-full p-2 border rounded bg-white"></div>
                        <div><label class="text-xs font-bold text-gray-700">Impuestos ITP (%):</label><input type="number" id="impCompraPct" value="10" class="w-full p-2 border rounded bg-white"></div>
                        <div><label class="text-xs font-bold text-gray-700">Notar√≠a/Registro (‚Ç¨):</label><input type="number" id="costeNotaria" value="1500" class="w-full p-2 border rounded bg-white"></div>
                    </div>
                    
                    <div class="space-y-3">
                        <h3 class="font-black text-amber-900 uppercase text-xs tracking-wider">B. Reforma y T√©cnicos</h3>
                        <div><label class="text-xs font-bold text-gray-700">Coste Reforma (‚Ç¨/m¬≤):</label><input type="number" id="costeReformaM2" value="1000" class="w-full p-2 border rounded bg-white"></div>
                        <div><label class="text-xs font-bold text-gray-700">Proyecto y Licencias (‚Ç¨):</label><input type="number" id="costeLicencias" value="6500" class="w-full p-2 border rounded bg-white"></div>
                        <div class="bg-white p-2 rounded border text-xs space-y-2">
                            <label class="flex items-center space-x-2"><input type="checkbox" id="extraCascoAntiguo" class="rounded text-amber-600"><span class="font-bold">+15% Log√≠stica Casco Ant.</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" id="tasaParking" class="rounded text-amber-600"><span class="font-bold text-red-600">+10k‚Ç¨ Multa Parking Ayto.</span></label>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h3 class="font-black text-amber-900 uppercase text-xs tracking-wider">C. Salida</h3>
                        <div><label class="text-xs font-bold text-gray-700">Comisi√≥n Inmobiliaria (%):</label><input type="number" id="honorariosVentaPct" value="3" class="w-full p-2 border rounded bg-white"></div>
                        <div><label class="text-xs font-bold text-gray-700">Otros (C√©dula/Altas) (‚Ç¨):</label><input type="number" id="otrosGastos" value="1000" class="w-full p-2 border rounded bg-white"></div>
                        <div><label class="text-xs font-black text-blue-700">PRECIO VENTA TOTAL (‚Ç¨):</label><input type="number" id="precioVenta" class="w-full p-3 border-2 border-blue-400 rounded bg-blue-50 font-bold"></div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="volver(2)" class="text-gray-500 hover:text-gray-800 font-bold py-3 px-6">‚¨Ö Atr√°s</button>
                    <button onclick="finalizarEvaluacion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg">Calcular Rentabilidad ‚ûî</button>
                </div>
            </div>

            <div id="paso4" class="paso-bloque hidden">
                <div id="resultadoExito" class="hidden">
                    <div class="text-center mb-8">
                        <div class="inline-block bg-green-100 text-green-600 p-4 rounded-full mb-4">
                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <h2 class="text-3xl font-black text-slate-900">¬°Operaci√≥n Altamente Rentable!</h2>
                        <p class="text-gray-600 mt-2">Esta propiedad cumple nuestros estrictos filtros de viabilidad de 9US.</p>
                    </div>

                    <div class="bg-slate-900 text-white rounded-2xl p-6 md:p-8 mb-8 shadow-2xl flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <span class="block text-gray-400 text-sm uppercase tracking-widest mb-1">Inversi√≥n Estimada</span>
                            <span id="resInversion" class="text-3xl font-bold text-red-400">0 ‚Ç¨</span>
                        </div>
                        <div>
                            <span class="block text-gray-400 text-sm uppercase tracking-widest mb-1">Beneficio Neto</span>
                            <span id="resBeneficio" class="text-3xl font-bold text-green-400">0 ‚Ç¨</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl text-center min-w-[150px]">
                            <span class="block text-blue-300 text-sm uppercase tracking-widest mb-1">R.O.I.</span>
                            <span id="resROI" class="text-4xl font-black text-white">0 %</span>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 md:p-8" data-html2canvas-ignore>
                        <h3 class="text-xl font-bold text-blue-900 mb-2">Hazlo realidad con 9US</h3>
                        <p class="text-sm text-blue-700 mb-6">D√©janos tus datos. Nos encargamos del proyecto t√©cnico, las licencias y la ejecuci√≥n de la obra para asegurar esta rentabilidad.</p>
                        
                        <form action="https://formspree.io/f/xjgeoblw" method="POST" class="space-y-4">
                            <input type="hidden" name="ROI_Estimado" id="hiddenRoi">
                            <input type="hidden" name="Beneficio_Estimado" id="hiddenBeneficio">
                            <input type="hidden" name="Municipio" id="hiddenMunicipio">
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-gray-700">Nombre completo:</label><input type="text" name="name" required class="w-full p-3 border rounded-lg bg-white mt-1"></div>
                                <div><label class="text-xs font-bold text-gray-700">Tel√©fono:</label><input type="tel" name="phone" required class="w-full p-3 border rounded-lg bg-white mt-1"></div>
                            </div>
                            <div><label class="text-xs font-bold text-gray-700">Email:</label><input type="email" name="email" required class="w-full p-3 border rounded-lg bg-white mt-1"></div>
                            
                            <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition-transform transform hover:-translate-y-1">
                                Solicitar Llamada Gratuita
                            </button>
                        </form>
                    </div>
                </div>

                <div id="resultadoFracaso" class="hidden text-center py-12">
                    <div class="inline-block bg-red-100 text-red-600 p-4 rounded-full mb-4">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </div>
                    <h2 class="text-3xl font-black text-slate-900 mb-2">Operaci√≥n Descartada</h2>
                    <p class="text-gray-600 text-lg">La rentabilidad estimada (<span id="roiFracaso" class="font-bold text-red-600"></span>) es inferior a nuestros est√°ndares del 10%, o existen riesgos insalvables.</p>
                    <p class="text-sm text-gray-500 mt-6">En 9US solo ejecutamos proyectos seguros y de alta rentabilidad para nuestros clientes.</p>
                </div>

                <div class="mt-8 flex justify-center gap-4 border-t pt-6" data-html2canvas-ignore>
                    <button onclick="volver(3)" class="text-gray-500 hover:text-gray-800 font-bold py-2 px-4">‚¨Ö Revisar Datos</button>
                    <button onclick="exportarPDF()" class="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                        üì• Descargar Informe PDF
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN BASE ---
        const normasMunicipios = {
            "barcelona": { visor: "https://ajuntament.barcelona.cat/informaciourbanistica/cerca/es/", supMinima: 40, avisoHumos: "üî¥ BCN exige extracci√≥n a cubierta.", avisoParking: "‚ÑπÔ∏è Parking sujeto a PGM." },
            "mataro": { visor: "https://www.mataro.cat/es/temas/urbanismo/planificacion-urbanistica/planeamiento-urbanistico-vigente/planeamiento-urbanistico-vigente", supMinima: 36, avisoHumos: "üî¥ Requiere cubierta.", avisoParking: "‚ö†Ô∏è PARKING: Exige vincular plaza." },
            "sabadell": { visor: "https://visors.sabadell.cat/VisorUrbanistic/", supMinima: 36, avisoHumos: "üü¢ Admiten carbono.", avisoParking: "‚ÑπÔ∏è Revisar ordenanza." },
            "terrassa": { visor: "https://aoberta.terrassa.cat/urbanisme/mapa/", supMinima: 36, avisoHumos: "üü¢ Posible carbono.", avisoParking: "‚ÑπÔ∏è Seg√∫n POUM." },
            "lhospitalet": { visor: "https://lhgeoportal.l-h.cat/", supMinima: 36, avisoHumos: "üî¥ Chimenea obligatoria.", avisoParking: "‚ÑπÔ∏è Rige PGM." },
            "general": { visor: "https://dtes.gencat.cat/muc-visor/", supMinima: 36, avisoHumos: "‚ÑπÔ∏è CTE exige salida.", avisoParking: "‚ÑπÔ∏è Consulta POUM local." }
        };
        let supMinimaActual = 36;
        let densidadValida = false;
        let tecnicaValida = false;

        function actualizarReglasMunicipio() {
            const mun = document.getElementById('municipioSelect').value;
            supMinimaActual = normasMunicipios[mun].supMinima;
            document.getElementById('avisoParking').innerText = normasMunicipios[mun].avisoParking;
            document.getElementById('avisoHumos').innerText = normasMunicipios[mun].avisoHumos;
            document.getElementById('avisosMunicipio').classList.remove('hidden');
        }
        function abrirVisor() { window.open(normasMunicipios[document.getElementById('municipioSelect').value].visor, '_blank'); }

        // --- 2. VALIDACIONES DE CADA PASO ---
        function calcularDensidad() {
            const p = parseFloat(document.getElementById('superficieParcela').value);
            const i = parseFloat(document.getElementById('indiceDensidad').value);
            const e = parseInt(document.getElementById('viviendasExistentes').value);
            if (!p || !i || isNaN(e)) return;
            const disp = Math.floor(p / i) - e;
            const res = document.getElementById('resultadoDensidad');
            res.classList.remove('hidden');
            if (disp > 0) {
                res.innerHTML = `‚úÖ Caben ${disp} vivienda(s) m√°s.`;
                res.className = "mt-2 text-center font-bold text-sm p-2 rounded text-green-700 bg-green-50 border border-green-400";
                document.getElementById('numViviendasPlan').value = disp;
                densidadValida = true;
            } else {
                res.innerHTML = `‚ùå Densidad agotada. Inviable.`;
                res.className = "mt-2 text-center font-bold text-sm p-2 rounded text-red-700 bg-red-50 border border-red-400";
                densidadValida = false;
            }
        }

        function evaluarTecnico() {
            const sup = parseFloat(document.getElementById('checkSuperficie').value);
            const fac = parseFloat(document.getElementById('checkFachada').value);
            const numVivs = parseInt(document.getElementById('numViviendasPlan').value) || 1;
            document.getElementById('labelSupMinima').innerText = `Sup. TOTAL (‚â•${supMinimaActual * numVivs}m¬≤):`;
            
            let supOk = false; let facOk = false;

            if (sup) {
                const reqSup = supMinimaActual * numVivs;
                const resSup = document.getElementById('resSuperficie');
                if (sup >= reqSup) { resSup.innerHTML = `‚úÖ Sup. Cumple`; resSup.className = "text-green-700 font-bold"; supOk = true; } 
                else { resSup.innerHTML = `‚ùå M√≠nimo ${reqSup}m¬≤`; resSup.className = "text-red-600 font-bold"; }
            }
            if (sup && fac) {
                const reqFac = sup / 9;
                const resFac = document.getElementById('resFachada');
                if (fac >= reqFac) { resFac.innerHTML = `‚úÖ Fachada Cumple`; resFac.className = "text-green-700 font-bold"; facOk = true; } 
                else { resFac.innerHTML = `‚ùå Insuficiente`; resFac.className = "text-red-600 font-bold"; }
            }
            tecnicaValida = (supOk && facOk);
        }

        // --- 3. MOTORES DEL WIZARD (Navegaci√≥n) ---
        function irPaso2() {
            if (!densidadValida) { alert("Debes verificar que la densidad es viable (Paso 1) antes de continuar."); return; }
            cambiarPaso(1, 2);
        }
        function irPaso3() {
            if (!tecnicaValida) { alert("Las medidas introducidas no cumplen la normativa t√©cnica m√≠nima. No se puede legalizar."); return; }
            cambiarPaso(2, 3);
        }
        function volver(destino) { cambiarPaso(destino + 1, destino); }

        function cambiarPaso(actual, destino) {
            document.getElementById(`paso${actual}`).classList.add('hidden');
            document.getElementById(`paso${destino}`).classList.remove('hidden');
            
            // Actualizar barra de progreso y colores
            const p = (destino - 1) * 33.3;
            document.getElementById('progressBar').style.width = `${p}%`;
            
            for(let i=1; i<=4; i++) {
                let txt = document.getElementById(`progText${i}`);
                if(i <= destino) { txt.classList.remove('text-gray-400'); txt.classList.add('text-blue-600'); }
                else { txt.classList.remove('text-blue-600'); txt.classList.add('text-gray-400'); }
            }
        }

        // --- 4. CIERRE Y C√ÅLCULO FINAL ---
        function finalizarEvaluacion() {
            const compra = parseFloat(document.getElementById('precioCompra').value) || 0;
            const venta = parseFloat(document.getElementById('precioVenta').value) || 0;
            if (compra === 0 || venta === 0) { alert("Completa Precio de Compra y Precio de Venta Estimado."); return; }

            // C√°lculos
            const m2 = parseFloat(document.getElementById('checkSuperficie').value) || 0;
            const numVivs = parseInt(document.getElementById('numViviendasPlan').value) || 1;
            const costeRef = (m2 * (parseFloat(document.getElementById('costeReformaM2').value) || 1000));
            const penalizacion = document.getElementById('extraCascoAntiguo').checked ? (costeRef*0.15) : 0;
            const parking = document.getElementById('tasaParking').checked ? (10000 * numVivs) : 0;

            const adquisicion = compra + (compra * ((parseFloat(document.getElementById('impCompraPct').value) || 10)/100)) + (parseFloat(document.getElementById('costeNotaria').value) || 0);
            const obra = costeRef + penalizacion + (parseFloat(document.getElementById('costeLicencias').value) || 0) + parking;
            const comercializacion = (parseFloat(document.getElementById('otrosGastos').value) || 0) + (venta * ((parseFloat(document.getElementById('honorariosVentaPct').value) || 3)/100));

            const inversionTotal = adquisicion + obra + comercializacion;
            const beneficio = venta - inversionTotal;
            const roi = inversionTotal > 0 ? (beneficio / inversionTotal) * 100 : 0;

            // Decision (Punto Cr√≠tico: 10% de Rentabilidad para 9US)
            if (roi >= 10) {
                document.getElementById('resultadoExito').classList.remove('hidden');
                document.getElementById('resultadoFracaso').classList.add('hidden');
                
                const fmt = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
                document.getElementById('resInversion').innerText = fmt.format(inversionTotal);
                document.getElementById('resBeneficio').innerText = fmt.format(beneficio);
                document.getElementById('resROI').innerText = roi.toFixed(1) + ' %';
                
                // Rellenar datos ocultos para el Formulario Formspree
                document.getElementById('hiddenRoi').value = roi.toFixed(1) + ' %';
                document.getElementById('hiddenBeneficio').value = fmt.format(beneficio);
                const mun = document.getElementById('municipioSelect');
                document.getElementById('hiddenMunicipio').value = mun.options[mun.selectedIndex].text;

            } else {
                document.getElementById('resultadoExito').classList.add('hidden');
                document.getElementById('resultadoFracaso').classList.remove('hidden');
                document.getElementById('roiFracaso').innerText = roi.toFixed(1) + ' %';
            }

            cambiarPaso(3, 4);
        }

        // --- 5. EXPORTAR PDF ---
        function exportarPDF() {
            const el = document.getElementById('informePDF');
            html2pdf().set({ margin: 10, filename: 'Evaluacion_9US.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } }).from(el).save();
        }

        window.onload = actualizarReglasMunicipio;
    </script>
</body>
</html>
